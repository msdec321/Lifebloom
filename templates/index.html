<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifebloom - A Restoration Druid Analysis Tool</title>
    <link rel="icon" type="image/jpeg" href="/static/icons/lifebloom.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #eee;
            display: flex;
        }

        .sidebar {
            width: 200px;
            background: #16213e;
            border-right: 2px solid #2a3f5f;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .sidebar-tab {
            padding: 15px 25px;
            cursor: pointer;
            color: #8b9dc3;
            font-weight: 600;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-tab:hover {
            background: #1a1a2e;
            color: #fff;
        }

        .sidebar-tab.active {
            background: #1a1a2e;
            color: #fff;
            border-left-color: #667eea;
        }

        .main-content {
            margin-left: 200px;
            flex: 1;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .druid-text {
            color: #DE772A;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #16213e;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            border: 1px solid #2a3f5f;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            border-color: #667eea;
        }

        .stat-card h3 {
            color: #8b9dc3;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .table-container {
            background: #16213e;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            overflow-x: auto;
            border: 1px solid #2a3f5f;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .table-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #8b9dc3;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filtered-count {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 500;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-controls label {
            color: #eee;
            font-weight: 600;
        }

        .table-controls input {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            width: 80px;
            background: #0f3460;
            color: #fff;
        }

        .table-controls input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .table-controls button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .table-controls button:hover {
            background: #5568d3;
        }

        .collapse-btn {
            background: #0f3460;
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 8px 16px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .collapse-btn:hover {
            background: #667eea;
        }

        .table-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }

        .table-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #16213e;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2a3f5f;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #8b9dc3;
        }

        .chart-container canvas {
            max-height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0f3460;
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a3f5f;
            color: #eee;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background-color: #1f2d47;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b9dc3;
            font-size: 1.2em;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-yes {
            background-color: #10b981;
            color: white;
        }

        .badge-no {
            background-color: #ef4444;
            color: white;
        }

        .controls {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2a3f5f;
        }

        .controls-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #8b9dc3;
            margin-bottom: 15px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .controls label {
            margin-right: 10px;
            font-weight: 600;
            color: #eee;
        }

        .controls select,
        .controls input {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            background: #0f3460;
            color: #fff;
        }

        .controls select {
            width: 150px;
            cursor: pointer;
        }

        .controls input {
            width: 100px;
        }

        .controls select:focus,
        .controls input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .controls button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            transition: background 0.2s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        .icon-buttons {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-bottom: 30px;
        }

        .icon-button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .icon-label {
            color: #8b9dc3;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .icon-button {
            background: #16213e;
            border: 2px solid #2a3f5f;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }

        .icon-button.active {
            border-color: #667eea;
            background: #0f3460;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .icon-button img {
            width: 44px;
            height: 44px;
            border-radius: 5px;
        }

        .notice-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #16213e 100%);
            border: 1px solid #667eea;
            border-radius: 10px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .notice-banner h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .notice-banner p {
            color: #c5d0e6;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .notice-banner p:last-child {
            margin-bottom: 0;
        }

        .notice-banner .signature {
            color: #8b9dc3;
            font-style: italic;
            margin-top: 15px;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #2a3f5f;
            margin: 25px 0;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(2, auto);
            gap: 5px 15px;
            margin-left: 5px;
        }

        .region-grid label {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .region-grid input {
            margin: 0;
            cursor: pointer;
        }

        .about-section {
            background: #16213e;
            border-radius: 10px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2a3f5f;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .about-section h2 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .about-section p {
            color: #c5d0e6;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .about-section.justified p {
            text-align: justify;
        }

        .about-section p:last-child {
            margin-bottom: 0;
        }

        .author-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .author-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #667eea;
            object-fit: cover;
        }

        .author-name {
            color: #fff;
            font-size: 1.5em;
            font-weight: 600;
        }

        .contact-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #0f3460;
            border: 1px solid #2a3f5f;
            border-radius: 6px;
            color: #c5d0e6;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .contact-link:hover {
            border-color: #667eea;
            background: #1a3f6f;
            color: #fff;
        }

        .contact-link.discord {
            cursor: default;
        }

        .author-section {
            display: flex;
            gap: 25px;
        }

        .author-section .author-avatar {
            flex-shrink: 0;
        }

        .author-content {
            flex: 1;
        }

        .author-content h2 {
            margin-top: 0;
        }

        .about-section ul {
            color: #c5d0e6;
            line-height: 1.7;
            margin: 15px 0;
            padding-left: 25px;
        }

        .about-section li {
            margin-bottom: 8px;
        }

        .about-section em {
            color: #667eea;
            font-style: italic;
        }

        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #2a3f5f;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Healer class colors */
        .healer-druid { color: #FF7C0A; }
        .healer-paladin { color: #F48CBA; }
        .healer-priest-holy { color: #FFFFFF; }
        .healer-priest-disc { color: #FFFFFF; }
        .healer-shaman { color: #0070DD; }

        /* Tank class color */
        .tank-badge {
            display: inline-block;
            padding: 6px 12px;
            background: #0f3460;
            border: 1px solid #2a3f5f;
            border-radius: 5px;
            color: #C41E3A;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-tab active" onclick="switchTab('analysis')">Analysis Tool</div>
        <div class="sidebar-tab" onclick="switchTab('report')">Report Analyzer</div>
        <div class="sidebar-tab" onclick="switchTab('theorycrafting')">Community Theorycrafting</div>
        <div class="sidebar-tab" onclick="switchTab('about')">About</div>
    </div>

    <div class="main-content">
        <!-- Analysis Tool Tab -->
        <div id="analysisTab" class="tab-content active">
            <div class="container">
                <h1 id="pageTitle">Lifebloom - A Restoration <span class="druid-text">Druid</span> Analysis Tool</h1>

                <div class="notice-banner">
                    <h3>Notice</h3>
                    <p>Welcome to Lifebloom! This is an application that collects and structures TBC Resto Druid data from WarcraftLogs in order to help facilitate retrospective data analyses by and for the community. This app is still in development in preparation for the next iteration of TBC Classic.</p>
                    <p>For more information about the tool and how to contact the author, please check out the "About" tab. Thanks!</p>
                    <p class="signature">-Mercy</p>
                </div>

                <hr class="section-divider">

        <div class="icon-buttons">
            <div class="icon-button-container">
                <div class="icon-label">Deep Resto</div>
                <button class="icon-button" id="treeOfLifeBtn">
                    <img src="/static/icons/treeoflife.jpg" alt="Tree of Life">
                </button>
            </div>
            <div class="icon-button-container">
                <div class="icon-label">Dreamstate</div>
                <button class="icon-button" id="dreamstateBtn">
                    <img src="/static/icons/dreamstate.jpg" alt="Dreamstate">
                </button>
            </div>
            <div class="icon-button-container">
                <div class="icon-label">Nature's Grace</div>
                <button class="icon-button" id="naturesGraceBtn">
                    <img src="/static/icons/naturesgrace.jpg" alt="Nature's Grace">
                </button>
            </div>
        </div>

        <div class="controls">
            <div class="controls-title">Filters</div>
            <div class="controls-row">
                <label for="dataset">Boss:</label>
                <select id="dataset" onchange="loadData()">
                    <option value="brutallus">Brutallus</option>
                    <option value="felmyst">Felmyst</option>
                </select>

                <label for="totalHealers">Total Healers:</label>
                <select id="totalHealers" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>

                <label for="shadowPriest">Shadow Priest:</label>
                <select id="shadowPriest" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>

                <label for="innervates">Innervates:</label>
                <select id="innervates" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>

                <label for="rotatingOnTank">Rotating on Tank:</label>
                <select id="rotatingOnTank" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>

                <span style="color: #8b9dc3; font-weight: 600; margin-left: 20px;">Region:</span>
                <div class="region-grid">
                    <label><input type="checkbox" id="regionUS" value="US" checked onchange="loadTopN()">US</label>
                    <label><input type="checkbox" id="regionEU" value="EU" checked onchange="loadTopN()">EU</label>
                    <label><input type="checkbox" id="regionCN" value="CN" checked onchange="loadTopN()">CN</label>
                    <label><input type="checkbox" id="regionKR" value="KR" checked onchange="loadTopN()">KR</label>
                </div>
            </div>
            <div class="controls-row" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a3f5f;">
                <span style="color: #8b9dc3; font-weight: 600; margin-right: 15px;">Healer Comp:</span>

                <label for="nDruid">Druids:</label>
                <select id="nDruid" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <label for="nPaladin">Paladins:</label>
                <select id="nPaladin" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <label for="nHPriest">Holy Priests:</label>
                <select id="nHPriest" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <label for="nDPriest">Disc Priests:</label>
                <select id="nDPriest" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <label for="nShaman">Shamans:</label>
                <select id="nShaman" onchange="loadTopN()">
                    <option value="">Any</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">HPS vs Duration</div>
                </div>
                <canvas id="hpsChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">HPS vs Haste</div>
                </div>
                <canvas id="hasteChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <span>Rankings</span>
                    <span class="filtered-count" id="filteredCount"></span>
                </div>
                <div class="table-controls">
                    <label for="topN">Show Top:</label>
                    <input type="number" id="topN" value="20" min="1" max="100">
                    <button onclick="loadTopN()">Update</button>
                    <button class="collapse-btn" id="collapseBtn" onclick="toggleTable()">Collapse</button>
                </div>
            </div>
            <div class="table-content" id="tableContent">
                <table id="dataTable">
                <thead>
                    <tr>
                        <th>Adjusted<br>Rank</th>
                        <th>Name</th>
                        <th>Server</th>
                        <th>Region</th>
                        <th>Duration</th>
                        <th>HPS</th>
                        <th>Haste</th>
                        <th>Spirit</th>
                        <th>Total<br>Healers</th>
                        <th>Innervates</th>
                        <th>Shadow<br>Priest</th>
                        <th>Rotating<br>on Tank</th>
                        <th>Primary<br>Rotation</th>
                        <th>Report<br>Link</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="14" class="loading">Loading data...</td>
                    </tr>
                </tbody>
            </table>
            </div>
        </div>
            </div>
        </div>

        <!-- Report Analyzer Tab -->
        <div id="reportTab" class="tab-content">
            <div class="container">
                <h1>Report Analyzer</h1>

                <div class="notice-banner">
                    <h3>Analyze Individual Reports</h3>
                    <p>Enter a WarcraftLogs report code (or full URL), the boss name, and the Restoration Druid's name to get a comprehensive performance analysis including rotation patterns, buff tracking, and HPS breakdown.</p>
                </div>

                <hr class="section-divider">

                <!-- Input Form -->
                <div class="controls" id="analyzerForm">
                    <div class="controls-title">Report Details</div>
                    <div class="controls-row" style="flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="reportCode">Report Code/URL:</label>
                            <input type="text" id="reportCode" placeholder="e.g., wX7H9RtYJ48P1cdW" style="width: 280px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="bossName">Boss:</label>
                            <select id="bossName" style="width: 180px;">
                                <option value="Brutallus">Brutallus</option>
                                <option value="Felmyst">Felmyst</option>
                                <option value="Eredar Twins">Eredar Twins</option>
                                <option value="M'uru">M'uru</option>
                                <option value="Kil'jaeden">Kil'jaeden</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="playerName">Player Name:</label>
                            <input type="text" id="playerName" placeholder="e.g., Mercychann" style="width: 180px;">
                        </div>
                        <button onclick="analyzeReport()" id="analyzeBtn">Analyze</button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="analyzerLoading" style="display: none; text-align: center; padding: 40px;">
                    <div style="color: #667eea; font-size: 1.2em; margin-bottom: 10px;">Analyzing report...</div>
                    <div style="color: #8b9dc3;">This may take 10-30 seconds depending on the report</div>
                    <div class="loading-spinner" style="margin-top: 20px;"></div>
                </div>

                <!-- Error Display -->
                <div id="analyzerError" style="display: none;" class="notice-banner" style="border-color: #ef4444;">
                    <h3 style="color: #ef4444;">Error</h3>
                    <p id="errorMessage" style="color: #fca5a5;"></p>
                </div>

                <!-- Results Container -->
                <div id="analyzerResults" style="display: none;">
                    <!-- Encounter Info -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Encounter Date</h3>
                            <div class="value" id="resultDate">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Duration</h3>
                            <div class="value" id="resultDuration">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Healers</h3>
                            <div class="value" id="resultHealers">-</div>
                        </div>
                    </div>

                    <!-- Player Performance -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">Player Performance</div>
                            <a id="reportLink" href="#" target="_blank" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">View on WarcraftLogs</a>
                        </div>
                        <div class="stats-grid" style="margin-bottom: 0;">
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Player</h3>
                                <div class="value" style="font-size: 1.5em;" id="resultPlayerName">-</div>
                                <div style="color: #8b9dc3; margin-top: 5px;" id="resultPlayerServer">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>HPS</h3>
                                <div class="value" style="color: #10b981;" id="resultHPS">-</div>
                                <div style="color: #8b9dc3; margin-top: 5px;" id="resultRank">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Stats</h3>
                                <div style="color: #fff; font-size: 1em;">
                                    <span id="resultIntellect">-</span> Int |
                                    <span id="resultSpirit">-</span> Spirit |
                                    <span id="resultHaste">-</span> Haste
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buffs & Resources -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">Buffs & Resources</div>
                        </div>
                        <div class="stats-grid" style="margin-bottom: 0;">
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Vampiric Touch</h3>
                                <div id="resultVT">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Innervate Count</h3>
                                <div class="value" id="resultInnervate">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Bloodlust/Heroism</h3>
                                <div id="resultBL">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Nature's Grace</h3>
                                <div id="resultNG">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trinkets -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">Trinkets</div>
                        </div>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="color: #8b9dc3; font-size: 0.9em; margin-bottom: 5px;">Trinket 1</div>
                                <div style="color: #fff; font-weight: 600;" id="resultTrinket1">-</div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <div style="color: #8b9dc3; font-size: 0.9em; margin-bottom: 5px;">Trinket 2</div>
                                <div style="color: #fff; font-weight: 600;" id="resultTrinket2">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- HoT Breakdown -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">HoT Breakdown</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Spell</th>
                                    <th>HPS</th>
                                    <th>% of Total</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong style="color: #10b981;">Lifebloom</strong></td>
                                    <td id="resultLBHPS">-</td>
                                    <td id="resultLBPercent">-</td>
                                    <td id="resultLBUptime">-</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #f472b6;">Rejuvenation</strong></td>
                                    <td id="resultRejuvHPS">-</td>
                                    <td id="resultRejuvPercent">-</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #60a5fa;">Regrowth</strong></td>
                                    <td id="resultRGHPS">-</td>
                                    <td id="resultRGPercent">-</td>
                                    <td id="resultRGRanks">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Healer Composition -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">Healer Composition</div>
                        </div>
                        <div id="healerCompList" style="display: flex; flex-wrap: wrap; gap: 20px;"></div>
                    </div>

                    <!-- Rotation Analysis -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">Rotation Analysis</div>
                            <button class="collapse-btn" onclick="toggleRotationTable()">Collapse</button>
                        </div>
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Total Rotations</h3>
                                <div class="value" id="resultRotationCount">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Tank Rotation %</h3>
                                <div class="value" id="resultTankRotation">-</div>
                            </div>
                            <div class="stat-card" style="box-shadow: none;">
                                <h3>Rotating on Tank</h3>
                                <div id="resultRotatingOnTank">-</div>
                            </div>
                        </div>
                        <div id="rotationTableContent">
                            <h4 style="color: #8b9dc3; margin-bottom: 15px;">Top Rotation Patterns</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Pattern</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="rotationPatternsBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cast Sequence -->
                    <div class="table-container" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div class="table-title">
                                <span>Cast Sequence</span>
                                <span class="filtered-count" id="castCount"></span>
                            </div>
                            <button class="collapse-btn" id="castSequenceCollapseBtn" onclick="toggleCastSequence()">Collapse</button>
                        </div>
                        <div id="castSequenceContent" style="max-height: 500px; overflow-y: auto;">
                            <table>
                                <thead style="position: sticky; top: 0; background: #0f3460;">
                                    <tr>
                                        <th>Time</th>
                                        <th>Spell</th>
                                        <th>Target</th>
                                        <th>Active Tank</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="castSequenceBody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Community Theorycrafting Tab -->
        <div id="theorycraftingTab" class="tab-content">
            <div class="container">
                <h1>Community Theorycrafting</h1>

                <div class="notice-banner">
                    <h3>Coming Soon</h3>
                    <p>This section will feature community-driven theorycrafting analyses, discussions, and findings about TBC Restoration Druid optimization.</p>
                </div>
            </div>
        </div>

        <!-- About Tab -->
        <div id="aboutTab" class="tab-content">
            <div class="container">
                <h1>About</h1>

                <div class="about-section">
                    <h2>About Lifebloom</h2>
                    <p>Lifebloom is an application that collects and structures TBC Resto Druid data from WarcraftLogs in order to help facilitate retrospective data analyses by and for the community. This app is still in development in preparation for the next iteration of TBC Classic.</p>
                </div>

                <div class="about-section justified">
                    <h2>Motivation</h2>
                    <p>The Burning Crusade is almost 20 years old! üéâ </p>
                        
                    <p>Despite so much time passing, I don't believe our collective understanding of Resto Druid has progressed significantly since 2007 - and not because the spec has been solved. With TBC Classic, I had hoped that the community would build upon existing knowledge from 2007 and the private server era, but instead what I observed was largely "re-discovery" and recycled guides, and very little theorycrafting or knowledge sharing. I think we can do better.</p>
                    <p>To illustrate, consider the following fundamental questions that I believe remain unanswered:</p>
                    <ul>
                        <li>For a given encounter, is there an optimal spell haste breakpoint?</li>
                        <li>For a given encounter, is there an optimal healing rotation?</li>
                    </ul>
                    <p>These questions appear straightforward, yet after 20 years neither has a definitive answer. Here's my hot take: traditional theorycrafting alone will never solve them.</p>
                    <p>The reason is multifaceted.</p>
                    <p>First, healer theorycrafting is inherently difficult. Raid encounters are complex environments with numerous confounding variables: healer count and composition, fight duration, access to Shadow Priest, etc. The optimal rotation for a 3-minute encounter may differ significantly from a 6-minute encounter due to mana constraints alone.</p>
                    <p>Second, the community is still split on whether HPS is a valid performance metric because of the confounding effects mentioned above. This has left us in a bit of theorycrafting ‚Äúquagmire‚Äù - without an objective measure of performance, the community instead relies on intuition and hand-wavy arguments about what is good or not. There‚Äôs a very clear dogma in the community on the topic of HPS, and just mentioning the word gets you harassed and dogpiled on. I think the community is wrong.</p>
                    <p>By analyzing large datasets while controlling for confounding variables we can isolate effects that you DO have control over - rotation, playstyle, gearing choices, haste breakpoints, etc. across different encounters and conditions. I don't believe these fundamental questions are unanswerable, but we need a new approach. That is the motivation for this tool: combining traditional theorycrafting with data-driven analyses to address fundamental questions and to advance our understanding of the spec.</p>
                </div>

                <div class="about-section author-section justified">
                    <img src="/static/icons/avatar.png" alt="Mercy" class="author-avatar">
                    <div class="author-content">
                        <h2>About the Author</h2>
                        <p>Welcome readers! My name is Mercy (IGN Mercychan) and I've been playing TBC Resto Druid religiously since c. 2017 from the private server era and through TBC Classic. In my opinion TBC was when the class design for Resto Druid was at its best. In my professional life I LARP as a Data Scientist, and I'm hoping to bring together my experience in data science and my passion for this spec in order to help the community push our knowledge of TBC Resto Druid further.</p>
                        <p>If you want to support this project, the best way that you can do that is by using the tool and discussing your insights with the community. The more people become aware of and use this tool for their own analyses, the more we can learn together. If you found the app useful, consider giving the repo a star!</p>
                        <p>If you want to report bugs, request additions to the tool or dataset, or even collab on an analysis, the best way to contact me is via Discord. I'm not always in the community servers but my DMs are open! Feel free to reach out.</p>

                        <div class="contact-links">
                            <a href="https://github.com/msdec321/Lifebloom" target="_blank" class="contact-link">GitHub Repo</a>
                            <a href="https://classic.warcraftlogs.com/character/us/benediction/mercychann?zone=1013&partition=6&metric=hps" target="_blank" class="contact-link">WarcraftLogs</a>
                            <a href="https://www.twitch.tv/mercylolk" target="_blank" class="contact-link">Twitch</a>
                            <span class="contact-link discord">Discord: Mercy9226</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName, updateHash = true) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all sidebar tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'analysis') {
                document.getElementById('analysisTab').classList.add('active');
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                if (updateHash) window.location.hash = 'analysis';
            } else if (tabName === 'report') {
                document.getElementById('reportTab').classList.add('active');
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                if (updateHash) window.location.hash = 'report-analyzer';
            } else if (tabName === 'theorycrafting') {
                document.getElementById('theorycraftingTab').classList.add('active');
                document.querySelector('.sidebar-tab:nth-child(3)').classList.add('active');
                if (updateHash) window.location.hash = 'theorycrafting';
            } else if (tabName === 'about') {
                document.getElementById('aboutTab').classList.add('active');
                document.querySelector('.sidebar-tab:nth-child(4)').classList.add('active');
                if (updateHash) window.location.hash = 'about';
            }
        }

        // Handle URL hash on page load and hash change
        function handleHashChange() {
            const hash = window.location.hash.slice(1); // Remove the '#'
            if (hash === 'report-analyzer' || hash === 'report') {
                switchTab('report', false);
            } else if (hash === 'theorycrafting') {
                switchTab('theorycrafting', false);
            } else if (hash === 'about') {
                switchTab('about', false);
            } else {
                switchTab('analysis', false);
            }
        }

        // Listen for hash changes (back/forward browser buttons)
        window.addEventListener('hashchange', handleHashChange);

        // Chart instances
        let hpsChart = null;
        let hasteChart = null;

        // Parse duration string (e.g., "4m 24s") to seconds
        function parseDurationToSeconds(duration) {
            if (!duration) return 0;
            let seconds = 0;
            const minuteMatch = duration.match(/(\d+)m/);
            const secondMatch = duration.match(/(\d+)s/);
            if (minuteMatch) seconds += parseInt(minuteMatch[1]) * 60;
            if (secondMatch) seconds += parseInt(secondMatch[1]);
            return seconds;
        }

        // Helper function to get selected regions
        function getSelectedRegions() {
            const regions = [];
            if (document.getElementById('regionUS').checked) regions.push('US');
            if (document.getElementById('regionEU').checked) regions.push('EU');
            if (document.getElementById('regionCN').checked) regions.push('CN');
            if (document.getElementById('regionKR').checked) regions.push('KR');
            return regions.join(',');
        }

        // Load and update chart with all filtered data
        async function updateChart() {
            const dataset = document.getElementById('dataset').value;
            const totalHealers = document.getElementById('totalHealers').value;
            const shadowPriest = document.getElementById('shadowPriest').value;
            const innervates = document.getElementById('innervates').value;
            const rotatingOnTank = document.getElementById('rotatingOnTank').value;
            const nDruid = document.getElementById('nDruid').value;
            const nPaladin = document.getElementById('nPaladin').value;
            const nHPriest = document.getElementById('nHPriest').value;
            const nDPriest = document.getElementById('nDPriest').value;
            const nShaman = document.getElementById('nShaman').value;
            const regions = getSelectedRegions();

            // Build URL with all filters but request all data (use high limit)
            let url = `/api/top/10000?dataset=${dataset}`;
            if (currentFilter !== null) {
                url += `&naturesGrace=${currentFilter}`;
            }
            if (totalHealers) {
                url += `&totalHealers=${totalHealers}`;
            }
            if (shadowPriest) {
                url += `&vampiricTouch=${shadowPriest}`;
            }
            if (innervates) {
                url += `&innervates=${innervates}`;
            }
            if (rotatingOnTank) {
                url += `&rotatingOnTank=${rotatingOnTank}`;
            }
            if (nDruid) {
                url += `&nDruid=${nDruid}`;
            }
            if (nPaladin) {
                url += `&nPaladin=${nPaladin}`;
            }
            if (nHPriest) {
                url += `&nHPriest=${nHPriest}`;
            }
            if (nDPriest) {
                url += `&nDPriest=${nDPriest}`;
            }
            if (nShaman) {
                url += `&nShaman=${nShaman}`;
            }
            if (regions) {
                url += `&regions=${regions}`;
            }

            try {
                const response = await fetch(url);
                const result = await response.json();
                const data = result.data;

                const ctx = document.getElementById('hpsChart').getContext('2d');

                // Parse data for chart
                const chartData = data.map(row => ({
                    x: parseDurationToSeconds(row.Duration),
                    y: row.HPS,
                    name: row.Name
                }));

                // Calculate min/max for y-axis
                const hpsValues = chartData.map(d => d.y);
                const minHPS = Math.min(...hpsValues);
                const yAxisMin = Math.max(0, minHPS - 100); // Don't go below 0

                // Destroy existing chart if it exists
                if (hpsChart) {
                    hpsChart.destroy();
                }

                // Create new chart
                hpsChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'HPS vs Duration',
                        data: chartData,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = chartData[context.dataIndex];
                                    return `${point.name}: ${point.y.toFixed(2)} HPS at ${point.x}s`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Duration (seconds)',
                                color: '#8b9dc3',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#8b9dc3'
                            },
                            grid: {
                                color: 'rgba(139, 157, 195, 0.1)'
                            }
                        },
                        y: {
                            min: yAxisMin,
                            title: {
                                display: true,
                                text: 'HPS',
                                color: '#8b9dc3',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#8b9dc3',
                                callback: function(value, index, ticks) {
                                    // Hide the minimum tick value
                                    if (index === 0) {
                                        return '';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                color: 'rgba(139, 157, 195, 0.1)'
                            }
                        }
                    }
                }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Load and update Haste chart with all filtered data
        async function updateHasteChart() {
            const dataset = document.getElementById('dataset').value;
            const totalHealers = document.getElementById('totalHealers').value;
            const shadowPriest = document.getElementById('shadowPriest').value;
            const innervates = document.getElementById('innervates').value;
            const rotatingOnTank = document.getElementById('rotatingOnTank').value;
            const nDruid = document.getElementById('nDruid').value;
            const nPaladin = document.getElementById('nPaladin').value;
            const nHPriest = document.getElementById('nHPriest').value;
            const nDPriest = document.getElementById('nDPriest').value;
            const nShaman = document.getElementById('nShaman').value;
            const regions = getSelectedRegions();

            // Build URL with all filters but request all data (use high limit)
            let url = `/api/top/10000?dataset=${dataset}`;
            if (currentFilter !== null) {
                url += `&naturesGrace=${currentFilter}`;
            }
            if (totalHealers) {
                url += `&totalHealers=${totalHealers}`;
            }
            if (shadowPriest) {
                url += `&vampiricTouch=${shadowPriest}`;
            }
            if (innervates) {
                url += `&innervates=${innervates}`;
            }
            if (rotatingOnTank) {
                url += `&rotatingOnTank=${rotatingOnTank}`;
            }
            if (nDruid) {
                url += `&nDruid=${nDruid}`;
            }
            if (nPaladin) {
                url += `&nPaladin=${nPaladin}`;
            }
            if (nHPriest) {
                url += `&nHPriest=${nHPriest}`;
            }
            if (nDPriest) {
                url += `&nDPriest=${nDPriest}`;
            }
            if (nShaman) {
                url += `&nShaman=${nShaman}`;
            }
            if (regions) {
                url += `&regions=${regions}`;
            }

            try {
                const response = await fetch(url);
                const result = await response.json();
                const data = result.data;

                const ctx = document.getElementById('hasteChart').getContext('2d');

                // Parse data for chart (filter out records with Haste = 0)
                const chartData = data
                    .filter(row => row.Haste > 0)
                    .map(row => ({
                        x: row.Haste,
                        y: row.HPS,
                        name: row.Name
                    }));

                // Calculate min for y-axis
                const hpsValues = chartData.map(d => d.y);
                const minHPS = Math.min(...hpsValues);
                const yAxisMin = Math.max(0, minHPS - 100);

                // Destroy existing chart if it exists
                if (hasteChart) {
                    hasteChart.destroy();
                }

                // Create new chart
                hasteChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'HPS vs Haste',
                            data: chartData,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = chartData[context.dataIndex];
                                        return `${point.name}: ${point.y.toFixed(2)} HPS at ${point.x} Haste`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Haste',
                                    color: '#8b9dc3',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#8b9dc3'
                                },
                                grid: {
                                    color: 'rgba(139, 157, 195, 0.1)'
                                }
                            },
                            y: {
                                min: yAxisMin,
                                title: {
                                    display: true,
                                    text: 'HPS',
                                    color: '#8b9dc3',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#8b9dc3',
                                    callback: function(value, index, ticks) {
                                        // Hide the minimum tick value
                                        if (index === 0) {
                                            return '';
                                        }
                                        return value;
                                    }
                                },
                                grid: {
                                    color: 'rgba(139, 157, 195, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading haste chart data:', error);
            }
        }

        // Toggle table collapse/expand
        function toggleTable() {
            const tableContent = document.getElementById('tableContent');
            const collapseBtn = document.getElementById('collapseBtn');

            if (tableContent.classList.contains('collapsed')) {
                tableContent.classList.remove('collapsed');
                tableContent.style.maxHeight = tableContent.scrollHeight + 'px';
                collapseBtn.textContent = 'Collapse';
            } else {
                tableContent.style.maxHeight = tableContent.scrollHeight + 'px';
                setTimeout(() => {
                    tableContent.classList.add('collapsed');
                }, 10);
                collapseBtn.textContent = 'Expand';
            }
        }

        // Update max-height when content changes
        function updateTableHeight() {
            const tableContent = document.getElementById('tableContent');
            if (!tableContent.classList.contains('collapsed')) {
                tableContent.style.maxHeight = tableContent.scrollHeight + 'px';
            }
        }

        // Global filter state
        let currentFilter = null;

        async function loadTopN() {
            const n = document.getElementById('topN').value || 20;
            const dataset = document.getElementById('dataset').value;
            const totalHealers = document.getElementById('totalHealers').value;
            const shadowPriest = document.getElementById('shadowPriest').value;
            const innervates = document.getElementById('innervates').value;
            const rotatingOnTank = document.getElementById('rotatingOnTank').value;
            const nDruid = document.getElementById('nDruid').value;
            const nPaladin = document.getElementById('nPaladin').value;
            const nHPriest = document.getElementById('nHPriest').value;
            const nDPriest = document.getElementById('nDPriest').value;
            const nShaman = document.getElementById('nShaman').value;
            const regions = getSelectedRegions();

            // Build URL with optional filters
            let url = `/api/top/${n}?dataset=${dataset}`;
            if (currentFilter !== null) {
                url += `&naturesGrace=${currentFilter}`;
            }
            if (totalHealers) {
                url += `&totalHealers=${totalHealers}`;
            }
            if (shadowPriest) {
                url += `&vampiricTouch=${shadowPriest}`;
            }
            if (innervates) {
                url += `&innervates=${innervates}`;
            }
            if (rotatingOnTank) {
                url += `&rotatingOnTank=${rotatingOnTank}`;
            }
            if (nDruid) {
                url += `&nDruid=${nDruid}`;
            }
            if (nPaladin) {
                url += `&nPaladin=${nPaladin}`;
            }
            if (nHPriest) {
                url += `&nHPriest=${nHPriest}`;
            }
            if (nDPriest) {
                url += `&nDPriest=${nDPriest}`;
            }
            if (nShaman) {
                url += `&nShaman=${nShaman}`;
            }
            if (regions) {
                url += `&regions=${regions}`;
            }

            try {
                const response = await fetch(url);
                const result = await response.json();
                const data = result.data;
                const totalCount = result.total_count;

                const tableBody = document.getElementById('tableBody');

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="14" style="text-align: center;">No data available</td></tr>';
                    document.getElementById('filteredCount').textContent = `(0 Filtered Records)`;
                    return;
                }

                tableBody.innerHTML = data.map(row => `
                    <tr>
                        <td>${row.AdjustedRank || 'N/A'}</td>
                        <td><strong>${row.Name || 'N/A'}</strong></td>
                        <td>${row.Server || 'N/A'}</td>
                        <td>${row.Region || 'N/A'}</td>
                        <td>${row.Duration || 'N/A'}</td>
                        <td><strong>${typeof row.HPS === 'number' && !isNaN(row.HPS) ? row.HPS.toFixed(2) : 'N/A'}</strong></td>
                        <td>${typeof row.Haste === 'number' && !isNaN(row.Haste) ? row.Haste : 'N/A'}</td>
                        <td>${typeof row.Spirit === 'number' && !isNaN(row.Spirit) ? row.Spirit : 'N/A'}</td>
                        <td>${row.TotalHealers || 'N/A'}</td>
                        <td>${typeof row.InnervateCount === 'number' ? row.InnervateCount : 'N/A'}</td>
                        <td>${row.VampiricTouch || 'N/A'}</td>
                        <td>${row.RotatingOnTank || 'N/A'}</td>
                        <td>${row.Rotation1 || 'N/A'}</td>
                        <td>${row.ReportLink ? `<a href="${row.ReportLink}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85em; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">View</a>` : 'N/A'}</td>
                    </tr>
                `).join('');

                // Update filtered count with total count from entire filtered dataset
                document.getElementById('filteredCount').textContent = `(${totalCount} Filtered Records)`;

                // Update charts with all filtered data (separate from table)
                updateChart();
                updateHasteChart();

                // Update table height after loading data
                setTimeout(updateTableHeight, 100);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" style="text-align: center; color: red;">Error loading data</td></tr>';
            }
        }

        // Function to load all data
        function loadData() {
            loadTopN();
        }

        // Function to set filter and update buttons
        function setFilter(filter, buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.icon-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // If clicking the same filter, toggle it off
            if (currentFilter === filter) {
                currentFilter = null;
            } else {
                currentFilter = filter;
                // Add active class to clicked button
                if (buttonId) {
                    document.getElementById(buttonId).classList.add('active');
                }
            }

            // Reload data with new filter
            loadTopN();
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Handle initial URL hash to show correct tab
            handleHashChange();

            loadData();

            // Add click handlers to icon buttons
            document.getElementById('treeOfLifeBtn').addEventListener('click', () => {
                setFilter('No', 'treeOfLifeBtn');
            });

            document.getElementById('naturesGraceBtn').addEventListener('click', () => {
                setFilter('Yes', 'naturesGraceBtn');
            });

            // Dreamstate button does nothing for now
            document.getElementById('dreamstateBtn').addEventListener('click', () => {
                // No action yet
            });
        });

        // ===== REPORT ANALYZER FUNCTIONS =====

        async function analyzeReport() {
            const reportCode = document.getElementById('reportCode').value.trim();
            const bossName = document.getElementById('bossName').value.trim();
            const playerName = document.getElementById('playerName').value.trim();

            // Validate inputs
            if (!reportCode || !bossName || !playerName) {
                showAnalyzerError('Please fill in all fields: Report Code, Boss Name, and Player Name.');
                return;
            }

            // Show loading, hide results and error
            document.getElementById('analyzerLoading').style.display = 'block';
            document.getElementById('analyzerResults').style.display = 'none';
            document.getElementById('analyzerError').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'Analyzing...';

            try {
                const response = await fetch('/api/analyze-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_code: reportCode,
                        boss_name: bossName,
                        player_name: playerName
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                displayAnalysisResults(data);

            } catch (error) {
                showAnalyzerError(error.message);
            } finally {
                document.getElementById('analyzerLoading').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'Analyze';
            }
        }

        function showAnalyzerError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('analyzerError').style.display = 'block';
            document.getElementById('analyzerResults').style.display = 'none';
        }

        function displayAnalysisResults(data) {
            // Show results container
            document.getElementById('analyzerResults').style.display = 'block';

            // Encounter info
            document.getElementById('resultDate').textContent = data.date;
            document.getElementById('resultDuration').textContent = data.duration;
            document.getElementById('resultHealers').textContent = data.total_healers;

            // Player performance
            document.getElementById('resultPlayerName').textContent = data.player_name;
            const ranking = data.player_ranking || {};
            document.getElementById('resultPlayerServer').textContent =
                ranking.server ? `${ranking.server} (${ranking.region})` : 'Unknown Server';

            const hps = ranking.hps || 0;
            document.getElementById('resultHPS').textContent = hps.toFixed(2);
            document.getElementById('resultRank').textContent =
                ranking.rank ? `Rank ${ranking.rank} of ${ranking.totalParses} (${ranking.rankPercent}th percentile)` : '-';

            // Stats
            const stats = data.player_stats || {};
            document.getElementById('resultIntellect').textContent = stats.has_stats ? stats.intellect : '?';
            document.getElementById('resultSpirit').textContent = stats.has_stats ? stats.spirit : '?';
            document.getElementById('resultHaste').textContent = stats.has_stats ? stats.haste : '?';

            // Buffs
            document.getElementById('resultVT').innerHTML = data.has_vampiric_touch
                ? '<span class="badge badge-yes">Yes</span>'
                : '<span class="badge badge-no">No</span>';
            document.getElementById('resultInnervate').textContent = data.innervate_count;
            document.getElementById('resultBL').innerHTML = data.has_bloodlust
                ? '<span class="badge badge-yes">Yes</span>'
                : '<span class="badge badge-no">No</span>';
            document.getElementById('resultNG').innerHTML = data.has_natures_grace
                ? '<span class="badge badge-yes">Yes</span>'
                : '<span class="badge badge-no">No</span>';

            // Trinkets
            const trinkets = data.player_trinkets || {};
            const trinketList = trinkets.trinkets || [];
            document.getElementById('resultTrinket1').textContent =
                trinketList[0] ? `${trinketList[0].name} (ID: ${trinketList[0].id})` : 'Unknown';
            document.getElementById('resultTrinket2').textContent =
                trinketList[1] ? `${trinketList[1].name} (ID: ${trinketList[1].id})` : 'Unknown';

            // HoT Breakdown
            const totalHPS = hps || 1; // avoid division by zero
            document.getElementById('resultLBHPS').textContent = data.lifebloom_hps.toFixed(2);
            document.getElementById('resultLBPercent').textContent = ((data.lifebloom_hps / totalHPS) * 100).toFixed(1) + '%';
            document.getElementById('resultLBUptime').textContent = `${data.lifebloom_uptime_percent}% uptime`;

            document.getElementById('resultRejuvHPS').textContent = data.rejuvenation_hps.toFixed(2);
            document.getElementById('resultRejuvPercent').textContent = ((data.rejuvenation_hps / totalHPS) * 100).toFixed(1) + '%';

            document.getElementById('resultRGHPS').textContent = data.regrowth_total_hps.toFixed(2);
            document.getElementById('resultRGPercent').textContent = ((data.regrowth_total_hps / totalHPS) * 100).toFixed(1) + '%';

            // Regrowth rank breakdown
            const rgRanks = data.regrowth_by_rank || {};
            const rgRankText = Object.entries(rgRanks)
                .filter(([rank, hps]) => hps > 0)
                .map(([rank, hps]) => `R${rank}: ${hps.toFixed(1)}`)
                .join(', ');
            document.getElementById('resultRGRanks').textContent = rgRankText || '-';

            // Healer Composition
            const healerComp = data.healer_composition || {};
            const healerCompHtml = Object.entries(healerComp).map(([type, players]) => {
                const colorClass = type.includes('Druid') ? 'healer-druid'
                    : type.includes('Paladin') ? 'healer-paladin'
                    : type.includes('Holy Priest') ? 'healer-priest-holy'
                    : type.includes('Discipline') ? 'healer-priest-disc'
                    : type.includes('Shaman') ? 'healer-shaman' : '';

                return `
                    <div style="flex: 1; min-width: 150px;">
                        <div style="color: #8b9dc3; font-size: 0.9em; margin-bottom: 5px;">${type} (${players.length})</div>
                        <div class="${colorClass}" style="font-weight: 600;">
                            ${players.length > 0 ? players.join(', ') : 'None'}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('healerCompList').innerHTML = healerCompHtml;

            // Rotation Analysis
            document.getElementById('resultRotationCount').textContent = data.rotation_count;
            document.getElementById('resultTankRotation').textContent = data.tank_rotation_percent + '%';
            document.getElementById('resultRotatingOnTank').innerHTML = data.rotating_on_tank
                ? '<span class="badge badge-yes">Yes</span>'
                : '<span class="badge badge-no">No</span>';

            // Rotation patterns table
            const patterns = data.sorted_patterns || [];
            const totalRotations = data.actual_rotations ? data.actual_rotations.length : 1;
            const patternsHtml = patterns.slice(0, 10).map((pattern, index) => {
                const [notation, count] = pattern;
                const percentage = ((count / totalRotations) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${notation}</strong></td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('rotationPatternsBody').innerHTML = patternsHtml || '<tr><td colspan="4">No rotation data</td></tr>';

            // Report link
            document.getElementById('reportLink').href = data.report_link;

            // Cast Sequence
            const castData = data.cast_data || [];
            document.getElementById('castCount').textContent = `(${castData.length} casts)`;

            let rotationNumber = 0;
            const castSequenceHtml = castData.map((cast, index) => {
                // Determine action string
                let actionStr = '';
                if (cast.rotation_start) {
                    actionStr = '<span style="color: #10b981; font-weight: 600;">Rotation started</span>';
                } else if (cast.instant_cast) {
                    actionStr = 'Instant cast';
                } else if (cast.regrowth) {
                    actionStr = 'Regrowth';
                } else {
                    actionStr = '-';
                }

                // Highlight lifebloom on tank
                const spellStyle = cast.rotation_start ? 'color: #10b981; font-weight: 600;' : '';

                // Add separator row before rotation starts (except the very first cast)
                let separatorRow = '';
                if (cast.rotation_start && index > 0) {
                    rotationNumber++;
                    separatorRow = `
                        <tr style="background: #0f3460; border-top: 2px solid #667eea;">
                            <td colspan="5" style="padding: 8px; color: #667eea; font-weight: 600; text-align: center;">
                                Rotation #${rotationNumber}
                            </td>
                        </tr>
                    `;
                } else if (cast.rotation_start && index === 0) {
                    rotationNumber++;
                }

                return `
                    ${separatorRow}
                    <tr>
                        <td>${cast.time.toFixed(2)}s</td>
                        <td style="${spellStyle}">${cast.spell}</td>
                        <td>${cast.target}</td>
                        <td style="color: #C41E3A;">${cast.active_tank}</td>
                        <td>${actionStr}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('castSequenceBody').innerHTML = castSequenceHtml || '<tr><td colspan="5">No cast data</td></tr>';
        }

        function toggleRotationTable() {
            const content = document.getElementById('rotationTableContent');
            const btn = content.previousElementSibling.previousElementSibling.querySelector('.collapse-btn');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Collapse';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Expand';
            }
        }

        function toggleCastSequence() {
            const content = document.getElementById('castSequenceContent');
            const btn = document.getElementById('castSequenceCollapseBtn');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Collapse';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Expand';
            }
        }

        // Allow Enter key to submit the form
        document.addEventListener('DOMContentLoaded', function() {
            ['reportCode', 'bossName', 'playerName'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            analyzeReport();
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
